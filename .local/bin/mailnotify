#!/bin/sh
# Check imapnotify configs and run goimapnotify with notify-send
# Reads all non-example YAML configs from ~/.config/imapnotify/

CONF_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/imapnotify"

configs=$(find "$CONF_DIR" -maxdepth 1 -name '*.yml' -o -name '*.yaml' | grep -v '\.example$')

if [ -z "$configs" ]; then
	echo "No imapnotify configs found in $CONF_DIR" >&2
	exit 1
fi

echo "Found configs:"
for conf in $configs; do
	echo "  $(basename "$conf")"

	# Validate required fields
	for field in host username; do
		if ! grep -q "[[:space:]]*$field:" "$conf"; then
			echo "    WARNING: missing '$field' in $(basename "$conf")" >&2
		fi
	done

	# Check if passwordCMD command exists
	passcmd=$(sed -n 's/^[[:space:]]*passwordCMD:[[:space:]]*"\(.*\)"/\1/p' "$conf")
	if [ -n "$passcmd" ]; then
		cmd=$(echo "$passcmd" | awk '{print $1}')
		if ! command -v "$cmd" >/dev/null 2>&1; then
			echo "    WARNING: password command '$cmd' not found" >&2
		fi
	fi
done

# Run goimapnotify for each config
for conf in $configs; do
	name=$(basename "$conf" | sed 's/\.\(yml\|yaml\)$//')
	echo "Starting goimapnotify for $name..."
	goimapnotify -conf "$conf" &
done

wait
