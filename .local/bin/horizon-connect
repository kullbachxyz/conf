#!/usr/bin/env bash
# ─────────────────────────────────────────────────────────────
#  horizon-connect  —  Omnissa Horizon wrapper for dwm
#
#  Deps : yad  (sudo apt install yad)
#
#  dwm float rule — add to config.h:
#    { "horizon-connect", NULL, NULL, 0, 1, -1 },
#  then recompile dwm.
# ─────────────────────────────────────────────────────────────

set -euo pipefail

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/horizon-connect"
CONFIG_FILE="$CONFIG_DIR/config"

mkdir -p "$CONFIG_DIR"
chmod 700 "$CONFIG_DIR"

# ── dependency check ───────────────────────────────────────────
if ! command -v yad &>/dev/null; then
  echo "ERROR: 'yad' is not installed."
  echo "  sudo apt install yad   or   sudo dnf install yad"
  exit 1
fi

# ── find horizon binary ────────────────────────────────────────
HORIZON_BIN=""
for c in vmware-view omnissa-horizon-client horizon-client; do
  if command -v "$c" &>/dev/null; then HORIZON_BIN="$c"; break; fi
done

if [[ -z "$HORIZON_BIN" ]]; then
  yad --error --title="Horizon Connect" --center \
      --text="Horizon client binary not found in PATH.\n\nLooked for: vmware-view, omnissa-horizon-client, horizon-client" \
      --button="OK:0" 2>/dev/null
  exit 1
fi

# ── load saved values ──────────────────────────────────────────
SAVED_SERVER="" SAVED_USER="" SAVED_DOMAIN=""
# Horizon-only color-scheme override. Does NOT touch your system gsettings.
# Edit ~/.config/horizon-connect/config to change:
#   HORIZON_COLOR_SCHEME="default"    # default | prefer-light | prefer-dark
#   HORIZON_GTK_THEME="Adwaita"       # Adwaita | Adwaita-dark | etc.
HORIZON_COLOR_SCHEME="default"
HORIZON_GTK_THEME="Adwaita"
[[ -f "$CONFIG_FILE" ]] && source "$CONFIG_FILE"

# ── build per-process dconf override for Horizon ──────────────
# Horizon reads color-scheme via dconf. We inject a custom profile
# so only the Horizon process sees our overrides, not the whole desktop.
DCONF_DIR="$CONFIG_DIR/dconf"
DCONF_DB_DIR="$DCONF_DIR/db/horizon-overrides.d"
mkdir -p "$DCONF_DB_DIR"

cat > "$DCONF_DB_DIR/00-horizon" <<DCONF
[org/gnome/desktop/interface]
color-scheme='${HORIZON_COLOR_SCHEME}'
gtk-theme='${HORIZON_GTK_THEME}'
DCONF

cat > "$DCONF_DIR/profile" <<PROFILE
user-db:user
system-db:horizon-overrides
PROFILE

if command -v dconf &>/dev/null; then
  dconf update "$DCONF_DIR/db" 2>/dev/null || true
fi

# ── CSS ────────────────────────────────────────────────────────
CSS=$(cat <<'CSS'
* {
  font-family: "IBM Plex Sans", "DejaVu Sans", sans-serif;
  font-size: 13px;
}
window, .background {
  background-color: #16181f;
}
.yad-form {
  background-color: #16181f;
  padding: 4px 8px;
}
label {
  color: #8b90a0;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.04em;
}
entry {
  background-color: #1e2130;
  color: #dde1ed;
  border: 1px solid #2e3347;
  border-radius: 5px;
  padding: 5px 10px;
  caret-color: #4f8ef7;
  min-width: 260px;
}
entry:focus {
  border-color: #4f8ef7;
  box-shadow: inset 0 0 0 1px #4f8ef7;
  background-color: #1e2338;
}
.dialog-action-area {
  background-color: #16181f;
  padding: 8px 12px 12px 12px;
  border-top: 1px solid #22263a;
}
.dialog-action-area button {
  border-radius: 5px;
  border: none;
  padding: 6px 20px;
  font-weight: 700;
  font-size: 12px;
  min-width: 80px;
}
.dialog-action-area button:first-child {
  background: linear-gradient(135deg, #3b72f2, #5b4fe8);
  color: #ffffff;
}
.dialog-action-area button:first-child:hover  { background: linear-gradient(135deg,#4f82ff,#6f62ff); }
.dialog-action-area button:first-child:active { background: #2a52c9; }
.dialog-action-area button:last-child {
  background-color: #252836;
  color: #7880a0;
  border: 1px solid #2e3347;
}
.dialog-action-area button:last-child:hover { background-color: #2e3347; color: #adb4cc; }
CSS
)

CSS_FILE="$(mktemp /tmp/horizon-css-XXXXXX.css)"
echo "$CSS" > "$CSS_FILE"
trap 'rm -f "$CSS_FILE"' EXIT

# ── enforce clean GTK theme ────────────────────────────────────
export GTK_THEME="Adwaita"
export GTK_CSD=0
unset GTK2_RC_FILES

# ── dialog ─────────────────────────────────────────────────────
#  --class sets WM_CLASS so dwm's float rule matches it
#  --focus-field 3 = password field (1-indexed) when server+user are pre-filled
FOCUS_ARG=()
[[ -n "$SAVED_SERVER" && -n "$SAVED_USER" ]] && FOCUS_ARG=(--focus-field 3)

FORM=$(
  yad \
    --class="horizon-connect" \
    --name="horizon-connect" \
    --title="Horizon Connect" \
    --form \
    --separator="|" \
    --center --on-top \
    --width=360 \
    --no-escape \
    --gtkrc "$CSS_FILE" \
    --image=none \
    --text="<span font='15' weight='bold' color='#4f8ef7'>Horizon</span><sup><span font='9' color='#4f8ef7'>®</span></sup>  <span font='10' color='#454a60'>$HORIZON_BIN</span>" \
    --text-align=left \
    --button="Connect:0" \
    --button="Cancel:1" \
    "${FOCUS_ARG[@]}" \
    --field="Server:"   "${SAVED_SERVER}" \
    --field="Username:" "${SAVED_USER}" \
    --field="Password:H" "" \
    2>/dev/null
) || { echo "Cancelled."; exit 0; }

# ── parse ──────────────────────────────────────────────────────
IFS="|" read -r SERVER USER PASS _rest <<< "$FORM"
SERVER="${SERVER// /}"
USER="${USER// /}"

[[ -z "$SERVER" ]] && {
  yad --error --title="Horizon Connect" --center \
      --text="Connection Server cannot be empty." --button="OK:0" 2>/dev/null
  exit 1
}
[[ -z "$USER" ]] && {
  yad --error --title="Horizon Connect" --center \
      --text="Username cannot be empty." --button="OK:0" 2>/dev/null
  exit 1
}

# ── silently save server, user, domain ────────────────────────
cat > "$CONFIG_FILE" <<CFG
SAVED_SERVER="$SERVER"
SAVED_USER="$USER"
CFG
chmod 600 "$CONFIG_FILE"

# ── launch Horizon with dark mode fixed ───────────────────────
CLI_ARGS=(
  --serverURL="$SERVER"
  --userName="$USER"
  --password="$PASS"
  --nonInteractive
)
[[ -n "$SAVED_DOMAIN" ]] && CLI_ARGS+=(--domainName="$SAVED_DOMAIN")

echo "→ $HORIZON_BIN ${CLI_ARGS[*]//--password=*/--password=***}"

# Point Horizon at our custom dconf profile so it reads our color-scheme override
export DCONF_PROFILE="$DCONF_DIR/profile"
export GTK_THEME="$HORIZON_GTK_THEME"
export GTK2_RC_FILES="/usr/share/themes/${HORIZON_GTK_THEME}/gtk-2.0/gtkrc"
export QT_STYLE_OVERRIDE="fusion"
unset GTK_APPLICATION_PREFER_DARK_THEME
export VMWARE_USE_SHIPPED_GTK=no

exec "$HORIZON_BIN" "${CLI_ARGS[@]}"
