#!/usr/bin/env bash
# ─────────────────────────────────────────────────────────────
#  horizon-connect  —  Omnissa Horizon wrapper for dwm
#
#  Deps : yad  (sudo apt install yad)
#
#  dwm float rule — add to config.h:
#    { "horizon-connect", NULL, NULL, 0, 1, -1 },
#  then recompile dwm.
# ─────────────────────────────────────────────────────────────

set -euo pipefail

CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/horizon-connect"
CONFIG_FILE="$CONFIG_DIR/config"

mkdir -p "$CONFIG_DIR"
chmod 700 "$CONFIG_DIR"

# ── dependency check ───────────────────────────────────────────
if ! command -v yad &>/dev/null; then
  echo "ERROR: 'yad' is not installed."
  echo "  sudo apt install yad   or   sudo dnf install yad"
  exit 1
fi

# ── find horizon binary ────────────────────────────────────────
HORIZON_BIN=""
for c in vmware-view omnissa-horizon-client horizon-client; do
  if command -v "$c" &>/dev/null; then HORIZON_BIN="$c"; break; fi
done

if [[ -z "$HORIZON_BIN" ]]; then
  yad --error --title="Horizon Connect" --center \
      --text="Horizon client binary not found in PATH.\n\nLooked for: vmware-view, omnissa-horizon-client, horizon-client" \
      --button="OK:0" 2>/dev/null
  exit 1
fi

# ── load saved values ──────────────────────────────────────────
SAVED_SERVER="" SAVED_USER="" SAVED_DOMAIN=""
[[ -f "$CONFIG_FILE" ]] && source "$CONFIG_FILE"

# ── CSS ────────────────────────────────────────────────────────
CSS=$(cat <<'CSS'
* {
  font-family: "IBM Plex Sans", "DejaVu Sans", sans-serif;
  font-size: 13px;
}
window, .background {
  background-color: #000000;
}
.yad-form {
  background-color: #000000;
  padding: 4px 8px;
}
label {
  color: #b0b3b4;
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 0.04em;
}
entry {
  background-color: #101112;
  color: #b0b3b4;
  border: 1px solid #222222;
  border-radius: 5px;
  padding: 5px 10px;
  caret-color: #b0b3b4;
  min-width: 260px;
}
entry:focus {
  border-color: #b0b3b4;
  box-shadow: inset 0 0 0 1px #b0b3b4;
  background-color: #222222;
}
.dialog-action-area {
  background-color: #000000;
  padding: 8px 4px 12px 4px;
  border-top: 1px solid #222222;
}
button {
  background-image: none;
  background-color: #101112;
  color: #b0b3b4;
  border: 1px solid #222222;
  border-radius: 5px;
  padding: 6px 20px;
  font-weight: 700;
  font-size: 12px;
  min-width: 80px;
  box-shadow: none;
  text-shadow: none;
}
button:hover {
  background-color: #222222;
  color: #b0b3b4;
  border-color: #b0b3b4;
}
button:active, button:checked {
  background-color: #b0b3b4;
  color: #000000;
}
.dialog-action-area button:first-child {
  border-color: #b0b3b4;
}
CSS
)

CSS_FILE="$(mktemp /tmp/horizon-css-XXXXXX.css)"
echo "$CSS" > "$CSS_FILE"
trap 'rm -f "$CSS_FILE"' EXIT

# ── enforce clean GTK theme ────────────────────────────────────
export GTK_THEME="Adwaita"
export GTK_CSD=0
unset GTK2_RC_FILES

# ── dialog ─────────────────────────────────────────────────────
#  --class sets WM_CLASS so dwm's float rule matches it
#  --focus-field 3 = password field when server+user are pre-filled
FOCUS_ARG=()
[[ -n "$SAVED_SERVER" && -n "$SAVED_USER" ]] && FOCUS_ARG=(--focus-field 3)

FORM=$(
  yad \
    --class="horizon-connect" \
    --name="horizon-connect" \
    --title="Horizon Connect" \
    --form \
    --separator="|" \
    --center --on-top \
    --width=360 \
    --no-escape \
    --gtkrc "$CSS_FILE" \
    --text="<span font='15' weight='bold' color='#b0b3b4'>Horizon Connect</span>\n" \
    --text-align=left \
    --button="Connect:0" \
    --button="Cancel:1" \
    "${FOCUS_ARG[@]}" \
    --field="Server:"    "${SAVED_SERVER}" \
    --field="Username:"  "${SAVED_USER}" \
    --field="Password:H" "" \
    2>/dev/null
) || { echo "Cancelled."; exit 0; }

# ── parse ──────────────────────────────────────────────────────
IFS="|" read -r SERVER USER PASS _rest <<< "$FORM"
SERVER="${SERVER// /}"
USER="${USER// /}"

[[ -z "$SERVER" ]] && {
  yad --error --title="Horizon Connect" --center \
      --text="Connection Server cannot be empty." --button="OK:0" 2>/dev/null
  exit 1
}
[[ -z "$USER" ]] && {
  yad --error --title="Horizon Connect" --center \
      --text="Username cannot be empty." --button="OK:0" 2>/dev/null
  exit 1
}

# ── silently save server and user ─────────────────────────────
cat > "$CONFIG_FILE" <<CFG
SAVED_SERVER="$SERVER"
SAVED_USER="$USER"
CFG
chmod 600 "$CONFIG_FILE"

# ── launch ─────────────────────────────────────────────────────
CLI_ARGS=(
  --serverURL="$SERVER"
  --userName="$USER"
  --password="$PASS"
  --nonInteractive
)
[[ -n "$SAVED_DOMAIN" ]] && CLI_ARGS+=(--domainName="$SAVED_DOMAIN")

echo "→ $HORIZON_BIN ${CLI_ARGS[*]//--password=*/--password=***}"

exec "$HORIZON_BIN" "${CLI_ARGS[@]}"
